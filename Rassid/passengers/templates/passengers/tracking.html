{% extends 'base.html' %}

{% block title %}Tracking Flight {{ flight.number|default:"AA123" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/tracking.css">
{% endblock %}

{% block content %}
<div class="tracking-container">
    <a href="{% url 'home' %}" class="back-link">‚Üê Back to Home</a>

    {% if view_mode == 'list' %}
    <div class="card">
        <h3>Live Flights</h3>
        <p>Select a flight to view detailed tracking information.</p>

        <div class="search-filter-container"
            style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <form method="GET" action="{% url 'tracking' %}" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" name="q" value="{{ search_query|default:'' }}"
                    placeholder="Search Flight #, Origin, or Destination" class="form-control"
                    style="flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">

                <select name="status" class="form-control"
                    style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Statuses</option>
                    <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="landed" {% if status_filter == 'landed' %}selected{% endif %}>Landed</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>

                <select name="origin_city" class="form-control"
                    style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all" {% if origin_city_filter == 'all' %}selected{% endif %}>All Origins</option>
                    {% for city in available_cities %}
                    {% if city %}
                    <option value="{{ city }}" {% if origin_city_filter == city %}selected{% endif %}>{{ city }}</option>
                    {% endif %}
                    {% endfor %}
                </select>

                <button type="submit" class="btn-primary" style="padding: 10px 20px;">Filter</button>
                {% if search_query or status_filter %}
                <a href="{% url 'tracking' %}" class="btn-outline"
                    style="padding: 10px 20px; text-decoration: none; display: inline-block; line-height: 20px;">Clear</a>
                {% endif %}
            </form>
        </div>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Flight</th>
                        <th>Route</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flight in flights %}
                    <tr>
                        <td><strong>{{ flight.flightNumber }}</strong></td>
                        <td>{{ flight.origin.code }} ‚Üí {{ flight.destination.code }}</td>
                        <td><span class="badge badge-info">{{ flight.status }}</span></td>
                        <td>{{ flight.scheduledDeparture|date:"H:i" }}</td>
                        <td>
                            <a href="{% url 'tracking_detail' flight.id %}" class="btn-primary-small">Track</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center;">No flights currently available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <a href="{% url 'tracking' %}" class="back-link" style="margin-bottom: 1rem; display:block;">‚Üê Back to Flight
        List</a>

    {% if flight %}
    <div class="flight-header card">
        <div class="flight-route">
            <div class="flight-number">Flight {{ flight.flightNumber }}</div>
            <div class="route-details">
                <span class="city">{{ flight.origin.code }}</span>
                <span class="arrow">‚Üí</span>
                <span class="city">{{ flight.destination.code }}</span>
            </div>
        </div>
        <div class="flight-status badge badge-info">
            Status: {{ flight.status }}
        </div>
    </div>

    <div class="gate-info-card card highlight-card">
        <div class="gate-header">
            <h3>Gate Information</h3>
        </div>
        <div class="gate-details">
            <div class="detail-item">
                <span class="label">Gate</span>
                <span class="value big">{{ flight.gate|default:"--" }}</span>
            </div>
            <div class="detail-item">
                <span class="label">Terminal</span>
                <span class="value">{{ flight.terminal|default:"--" }}</span>
            </div>
            <div class="detail-item">
                <span class="label">Boarding Open</span>
                <span class="value">{{ flight.boarding_open|default:"--:--" }}</span>
            </div>
            <div class="detail-item">
                <span class="label">Boarding Close</span>
                <span class="value">{{ flight.boarding_close|default:"--:--" }}</span>
            </div>
        </div>
        <div class="countdown-timer">
            Countdown: <span id="timer">-- minutes remaining</span>
        </div>
    </div>

    <div class="timeline card highlight-card">
        <h3>Live Updates</h3>
        <ul class="timeline-list">
            {% for event in history %}
            <li class="timeline-item">
                <span class="time">{{ event.changedAt|date:"H:i" }}</span>
                <div class="content">
                    <strong>{{ event.newStatus }}</strong>
                    <p>{{ event.changedAt|date:"M d, Y" }}</p>
                </div>
            </li>
            {% empty %}
            <li class="timeline-item">
                <span class="time">--:--</span>
                <div class="content">
                    <strong>Scheduled</strong>
                    <p>Flight scheduled.</p>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <button onclick="window.location.reload()" class="btn-primary refresh-btn">Refresh</button>

    <div class="map-container card">
        <div class="map-placeholder">
            [Airport Map Visualization]
            <div class="pin">üìç Gate {{ flight.gate|default:"?" }}</div>
        </div>
        <button class="btn-outline map-btn">Get Directions</button>
    </div>
    {% else %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <h3>No Flight Found</h3>
        <p>This flight ID does not exist.</p>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}