<!DOCTYPE html>
<html lang="{{ passenger.preferredLanguage }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Flight {{ flight.flightNumber }} | Rassid</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/tracker.css' %}">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
        }

        .floor-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }

        .floor-btn {
            padding: 5px 15px;
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .floor-btn.active {
            background: var(--primary, #0056b3);
            color: white;
            border-color: var(--primary, #0056b3);
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-nav">
            <a href="/" class="back-btn">← Back to Home</a>
        </div>

        <div class="page-title">Passenger Tracking</div>

        <div class="card">
            <div class="flight-number">Flight Number: {{ flight.flightNumber }}</div>
            <div class="flight-header">
                <div class="flight-route">
                    {{ flight.origin.code }} <span style="color:var(--text-light)">→</span> {{ flight.destination.code}}
                </div>
                <div class="status-badge status-{{ flight.status|lower }}">
                    Status: {{ flight.status }}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="page-title" style="margin-bottom: 1rem; font-size: 1rem;">Gate Information</div>
            <div class="gate-grid">
                <div class="gate-item">
                    <label>Gate</label>
                    <div class="value">{{ gate.gateCode|default:"--" }}</div>
                </div>
                <div class="gate-item">
                    <label>Terminal</label>
                    <div class="value">{{ gate.terminal|default:"--" }}</div>
                </div>
                <div class="gate-item">
                    <label>Boarding Open</label>
                    <div class="value">{{ gate.boardingOpenTime|date:"H:i"|default:"--" }}</div>
                </div>
                <div class="gate-item">
                    <label>Boarding Close</label>
                    <div class="value">{{ gate.boardingCloseTime|date:"H:i"|default:"--" }}</div>
                </div>
            </div>

            <div class="countdown-box" id="countdown">
                {% if phase == 'pre_open' %}
                Boarding opens in {{ formatted_open }}
                {% elif phase == 'boarding' %}
                Boarding closes in {{ formatted_close }}
                {% elif phase == 'closed' %}
                Boarding Closed
                {% else %}
                Gate info waiting...
                {% endif %}
            </div>
        </div>

        <div class="card timeline-section">
            <h3>Updates Timeline</h3>

            {% if not timeline %}
            <div style="color: var(--text-light); font-style: italic;">No updates yet.</div>
            {% endif %}

            {% for event in timeline %}
            <div class="timeline-item">
                <div class="timeline-time">{{ event.timestamp|date:"h:i A" }}</div>
                <div class="timeline-title">{{ event.title }}</div>
                <div class="timeline-desc">{{ event.description }}</div>
            </div>
            {% endfor %}

            <div class="timeline-item">
                <div class="timeline-time">{{ flight.scheduledDeparture|date:"h:i A" }} (Scheduled)</div>
                <div class="timeline-title">Flight Scheduled</div>
                <div class="timeline-desc">Flight {{ flight.flightNumber }} added to schedule.</div>
            </div>
        </div>

        <div style="text-align: left; margin-bottom: 2rem;">
            <button onclick="window.location.reload()" class="back-btn">Refresh</button>
        </div>

        <div class="card">

            <div id="map"></div>
            <button onclick="alert('Opening Maps...')" class="action-btn">Get Directions</button>
        </div>

    </div>

    <script>
        // Mapbox & Flight Data
        const MAPBOX_TOKEN = "{{ mapbox_access_token }}";
        const BUILDING_ID = "{{ map_building_id }}";
        const DEFAULT_FLOOR = "{{ map_floor_id }}";
        const GATE_STR = "{{ gate_coords }}"; // "Lat,Long" string

        mapboxgl.accessToken = MAPBOX_TOKEN;

        // Parse Gate Coords (Expects "Lat,Long" -> Mapbox needs [Long, Lat])
        let center = [46.7028, 24.9576]; // Default RUH
        let hasGate = false;

        if (GATE_STR && GATE_STR.includes(',')) {
            const parts = GATE_STR.split(',');
            // If string is "Lat,Long", flip to [Long, Lat]
            center = [parseFloat(parts[1]), parseFloat(parts[0])];
            hasGate = true;
        }

        // Default View (RUH)
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10', // Dark mode for premium feel
            center: center,
            zoom: hasGate ? 17 : 15,
            pitch: 60, // 3D perspective
            bearing: -17.6,
            antialias: true
        });

        // Add Marker if we have a gate
        if (hasGate) {
            new mapboxgl.Marker({ color: "#ef4444" }) // Red marker
                .setLngLat(center)
                .addTo(map);
        }

        let currentFloor = DEFAULT_FLOOR;
        let mapData = null;

        map.on('load', () => {
            // Optional: Load floor data if needed for 3D layout, 
            // but keeping it simple as requested: "put the old one ... with a marker"
            // If user wants full 3D layout again, we can uncomment loadFloorData
            // For now, focusing on the marker requirement.

            // Restore 3D Buildings for context
            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 15,
                'paint': {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'height']
                    ],
                    'fill-extrusion-base': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'min_height']
                    ],
                    'fill-extrusion-opacity': 0.6
                }
            });
        });

        function switchFloor(floorId) {
            console.log("Floor switching simplified for marker view.");
        }
    </script>

</body>

</html>